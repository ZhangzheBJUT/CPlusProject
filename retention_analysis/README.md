retention_count | retention_sum aggregate
=============================
## Benchmark
**单机测试环境：8C 16G**

| 数据量     | 留存函数运行耗时 | 普通JOIN查询耗时 |
| ---------- | ---------------- | ---------------  | 
| 10,000     | 	33.543ms        |  217.587 ms      | 
| 100,000    |  351.387 ms      |  4,227.037 ms    |  
| 1,000,000  |  8,289.095ms     |  50,401.620 ms   |  
| 10,000,000 |  83,759.686ms    |  7.8min (468368.176ms)|  
见：[benchmark.sql](./benchmark_sql/benchmark.sql "benchmark.sql") 

## INSTALL
1. make && make install
2. load test data (benchmark_sql/tmp.sql)
3. create extension retention_analysis
4. query sql

```
postgres=# create extension retention_analysis;
CREATE EXTENSION
postgres=#
SELECT retention_sum(retention_state) AS result
FROM (
  SELECT distinct_id,retention_count(ds,'YYYYmmdd',type,'day') AS retention_state
  FROM (
    SELECT 0 AS type,distinct_id,ds
    FROM event_log_10000
    WHERE ds>='20200501' AND ds<='20200531' AND token = '5aa67c90f29d980c06000125' AND event_name='initial'
    GROUP BY distinct_id,ds
    UNION ALL
    SELECT 1 AS type,distinct_id,ds
    FROM event_log_10000
    WHERE ds>='20200501' AND ds<='20200531' AND token = '5aa67c90f29d980c06000125' AND event_name='return'
    GROUP BY distinct_id,ds
  )t1
  GROUP BY distinct_id
)t2;
                                                                                                                              result
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"20200501:144,25,29,23,22,20,21,19,25,21","20200502:133,19,32,24,23,17,19,13,17","20200503:139,22,20,18,13,19,21,26,30","20200504:156,20,20,21,31,26,23,22,18","20200505:152,25,23,21,25,18,23,25,23","20200506:132,16,28,20,17,28,18,28,26","20200507:138,23,17,22,19,14,18,20,20","20200508:151,25,21,24,27,22,26,24,26","20200509:148,21,21,16,28,19,17,20,25","20200510:154,26,25,25,15,24,18,29,17","20200511:139,21,20,20,21,18,27,22,25","20200512:144,26,33,25,16,23,21,28,28","20200513:147,21,26,20,24,18,19,20,26","20200514:155,24,26,20,22,30,19,24,23","20200515:148,17,19,24,22,21,23,21,23","20200516:142,26,19,30,16,23,17,25,21","20200517:146,25,25,16,19,23,26,18,27","20200518:145,28,26,15,20,24,22,27","20200519:154,25,25,21,25,26,20,37","20200520:150,29,19,22,14,16,26,24","20200521:139,21,17,21,21,26,24,25","20200522:153,21,18,31,35,26,26,17","20200523:159,23,44,30,23,22,23,20","20200524:152,30,36,26,22,20,18,27","20200525:149,31,27,18,21,21,25","20200526:127,19,15,13,15,20","20200527:149,27,21,28,14","20200528:143,22,24,25","20200529:140,13,21","20200530:157,23",20200531:145}
(1 row)
Time: 54.098 ms
```
